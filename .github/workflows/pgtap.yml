name: Run pgtap tests
on: push
# on:
#   push:
#     paths:
#       - 'Open-ILS/src/sql/**'
#   pull_request:
#     paths:
#       - 'Open-ILS/src/sql/**'
jobs:
  pgtap:
    name: Run PgTap tests
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        pg-version: [13, 14, 15]
    steps:
      - uses: actions/checkout@v4
      - name: Install postgres
        run: sudo make -f Open-ILS/src/extras/Makefile.install postgres-server-ubuntu-jammy-${{matrix.pg-version}}

      - name: create evergreen db superuser
        run: sudo su - postgres -c 'createuser -s -P evergreen <<< $"password\npassword\n"'
      - name: Allow local connections
        run: sudo echo "local all all              trust" >> /etc/postgresql/${{matrix.pg-version}}/main/pg_hba.conf
      - name: Restart postgres
        run: sudo service postgres restart

      - name: Build the database schema
        run: "Open-ILS/src/sql/Pg/build-db.sh localhost 5432 postgres postgres postgres 1"

      - name: Setup pgtap on database
        uses: actions/checkout@v2
        with:
          repository: theory/pgtap
          path: pgtap
      - name: Install pgtap
        working-directory: pgtap
        run: make && make install
        env:
          PGPASSWORD: postgres


# TODO:
# run that script
# run the sample data loader
# run pgtap
# run pgtap regress
# run pgtap live
# matrix of postgres versions
# setup to run only on changes to the db directory, sample data, or db script (or its dependencies, if it has some?)
